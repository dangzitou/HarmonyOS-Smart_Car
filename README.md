# OpenHarmony智能小车

## 项目简介

本项目是基于OpenHarmony物联网轻量级系统开发的智能机器人小车演示程序，支持多种控制模式，包括循迹、超声波避障和手动控制等功能。项目采用Hi3861开发板作为主控芯片，集成了多种传感器和执行器。

## 功能特性

- **多模式切换**：通过按键切换停止、循迹、超声波避障三种工作模式
- **智能循迹**：基于红外传感器实现黑线循迹，支持实时速度调节和智能避障
- **超声波避障**：利用HC-SR04超声波传感器检测障碍物，自动规避碰撞
- **舵机控制**：SG90舵机实现转向控制，增强避障能力
- **OLED显示**：SSD1306 OLED屏幕实时显示当前工作状态和参数
- **速度控制**：支持通过按键调节小车运行速度，可调范围0-8000
- **PWM驱动**：采用PWM控制电机转速，运行更平稳稳定
- **融合避障循迹**：循迹模式下自动检测前方障碍物，实现安全循迹

## 硬件组成

| 组件 | 型号 | 连接GPIO | 功能描述 |
|------|------|----------|----------|
| 主控芯片 | Hi3861 | - | 系统核心控制器 |
| 电机驱动 | L9110S | GPIO0/1/9/10 | 双轮差速驱动 |
| 超声波传感器 | HC-SR04 | GPIO7/8 | 距离检测(Trig/Echo) |
| 舵机 | SG90 | GPIO2 | 转向控制 |
| 红外传感器 | TCRT5000 | GPIO11/12 | 循迹检测(左/右) |
| OLED显示屏 | SSD1306 | GPIO13/14 | 状态显示(SDA/SCL) |
| 按键/电位器 | - | GPIO5 | 模式切换和速度调节 |

## 目录结构

```
robot_demo/
├── BUILD.gn                # 构建配置文件
├── robot_control.c         # 主控制逻辑
├── robot_control.h         # 控制接口头文件
├── robot_hcsr04.c          # 超声波传感器驱动
├── robot_l9110s.c          # 电机驱动控制
├── robot_sg90.c            # 舵机控制
├── trace_model.c           # 循迹模块
├── ssd1306_test.c          # OLED显示控制
├── ssd1306/                # OLED驱动库
│   ├── BUILD.gn
│   ├── ssd1306.c
│   ├── ssd1306.h
│   ├── ssd1306_conf.h
│   ├── ssd1306_fonts.c
│   └── ssd1306_fonts.h
└── README.md               # 项目说明文档
```

## 工作模式

### 1. 停止模式（CAR_STOP_STATUS）
- 小车停止运动，所有电机刹车
- OLED显示 "Robot Car Stop"
- 等待用户切换到其他模式

### 2. 循迹模式（CAR_TRACE_STATUS）
- 基于红外传感器检测黑线轨道
- 自动调整左右轮速度保持循迹
- **融合避障功能**：每50ms检测前方障碍物
- 检测到障碍物时自动停车，距离安全后恢复循迹
- 支持四种运动状态：
  - 直行：两个传感器都检测到白色
  - 左转：左传感器检测到黑线，右传感器检测到白色
  - 右转：右传感器检测到黑线，左传感器检测到白色
  - 刹车：两个传感器都检测到黑线
- OLED显示 "trace" 和当前速度
- 支持实时速度调节（通过S1、S2）

### 3. 超声波避障模式（CAR_OBSTACLE_AVOIDANCE_STATUS）
- 前方检测到障碍物时自动避障
- 舵机左右转动探测最佳路径
- 距离小于20cm时后退并转向
- OLED显示 "ultrasonic"

## 控制接口

### 按键控制
- **短按USER**：循环切换工作模式（停止→循迹→避障→停止）
- **按键调节**：在循迹模式下调节运行速度, S1加速, S2减速

### 速度参数
- `SPEED_FORWARD`：前进速度（默认：6000，范围：0-8000）
- `SPEED_TURN`：转弯速度（默认：5000，范围：0-8000）
- `PWM_DUTY_MAX`：最大PWM占空比（8000）
- `PWM_FREQ`：PWM频率（8000Hz）
- 速度调节步长：500

### 避障参数
- `DISTANCE_BETWEEN_CAR_AND_OBSTACLE`：避障检测距离（20.0cm）
- 避障检测频率：每50ms检测一次
- 红外传感器采样频率：每1ms采样一次

## 编译和运行

### 环境要求
- OpenHarmony 3.0 LTS 或更高版本
- Hi3861开发板
- DevEco Device Tool

### 编译步骤
1. 确保项目位于OpenHarmony源码树中
2. 配置构建环境：
```bash
hb set
# 选择hispark_pegasus产品
```

3. 编译项目：
```bash
hb build
```

4. 烧录固件到Hi3861开发板

### 运行说明
1. 上电后系统自动初始化
2. OLED屏幕显示 "Hello OpenHarmony!"
3. 按下按键切换到所需工作模式
4. 观察OLED显示的状态信息

## 技术特点

- **实时性**：采用1ms定时器确保循迹响应速度
- **安全性**：循迹模式下自动避障，防止碰撞
- **智能检测**：50ms超声波检测周期，平衡性能与功耗
- **稳定性**：按键防抖设计，避免误触发
- **精确控制**：PWM驱动电机，速度控制精确平滑
- **可扩展性**：模块化设计，便于功能扩展
- **节能设计**：优化检测频率，降低系统功耗

## 故障排除

### 常见问题及解决方案

#### 1. 循迹不稳定
- **现象**：小车循迹时摇摆不定或偏离轨道
- **原因**：红外传感器高度不当或轨道反射不均匀
- **解决**：
  - 调整传感器高度至距离地面2-3cm
  - 使用黑色电胶带制作清晰轨道
  - 检查传感器是否被遮挡

#### 2. 避障功能异常
- **现象**：检测到障碍物但不停车，或无障碍物时误停
- **原因**：超声波传感器接线问题或环境干扰
- **解决**：
  - 检查GPIO7(Trig)和GPIO8(Echo)连接
  - 避免在强光或声音干扰环境下使用
  - 确保前方有足够的检测空间

#### 3. 小车不动或速度异常
- **现象**：PWM输出异常或电机不转
- **原因**：电源供电不足或驱动电路故障
- **解决**：
  - 检查电池电压是否充足（≥7.4V）
  - 确认L9110S驱动板连接正确
  - 检查PWM信号输出是否正常

#### 4. OLED显示异常
- **现象**：屏幕无显示或显示乱码
- **原因**：I2C通信问题或初始化失败
- **解决**：
  - 检查GPIO13(SDA)和GPIO14(SCL)连接
  - 确认OLED模块电源连接
  - 重新上电复位系统

## 性能优化建议

### 硬件优化
1. **电源系统**：使用稳压模块确保供电稳定
2. **传感器安装**：确保红外传感器水平安装，高度一致
3. **机械结构**：减少车体重量，提高机械精度
4. **线路布局**：使用屏蔽线减少电磁干扰

### 软件优化
1. **定时器优化**：可根据实际需求调整检测频率
2. **滤波算法**：对传感器数据进行软件滤波
3. **PID控制**：实现更精确的速度和方向控制
4. **状态机优化**：增加更多的运动状态以适应复杂路况

### 扩展功能建议
1. **蓝牙控制**：添加蓝牙模块实现远程控制
2. **摄像头模块**：集成摄像头进行视觉导航
3. **语音提示**：添加蜂鸣器或语音模块
4. **数据记录**：记录运行轨迹和性能数据

## 核心算法

### 循迹算法
```c
// 循迹逻辑状态机
if (左传感器 == 黑线 && 右传感器 == 黑线) {
    状态 = 刹车;  // 停止或减速
} else if (右传感器 == 黑线 && 左传感器 == 白色) {
    状态 = 右转;  // 左轮转动，右轮停止
} else if (左传感器 == 黑线 && 右传感器 == 白色) {
    状态 = 左转;  // 右轮转动，左轮停止
} else if (左传感器 == 白色 && 右传感器 == 白色) {
    状态 = 直行;  // 双轮同速前进
}
```

### 避障算法
```c
// 每50ms执行一次避障检测
if (检测计数器 >= 50) {
    距离 = GetDistance();
    if (距离 < 20cm) {
        if (!已检测到障碍物) {
            停止小车();
            设置避障标志();
        }
    } else {
        if (已检测到障碍物) {
            清除避障标志();
            恢复循迹();
        }
    }
}
```

## 贡献指南

欢迎对本项目做出贡献！您可以通过以下方式参与：

### 代码贡献
1. Fork本项目到您的GitHub仓库
2. 创建特性分支：`git checkout -b feature/new-feature`
3. 提交更改：`git commit -am 'Add new feature'`
4. 推送分支：`git push origin feature/new-feature`
5. 创建Pull Request

### 问题反馈
- 通过GitHub Issues报告Bug
- 提出功能改进建议
- 分享使用经验和技巧

### 文档改进
- 完善技术文档
- 添加使用示例
- 翻译多语言版本

## 版本历史

### v2.0.0 (2025-01-06)
- 新增融合避障循迹功能
- 优化超声波检测频率（50ms）
- 改进PWM控制精度
- 完善错误处理机制

### v1.5.0 (2024-12-15)
- 添加OLED显示支持
- 实现多模式切换
- 优化按键防抖算法

### v1.0.0 (2024-11-01)
- 基础循迹功能实现
- 超声波避障功能
- PWM电机控制

## 贡献者信息

### 主要贡献者
- **项目发起人**：[HiHope开源社区](https://gitee.com/hihope_iot)
- **技术支持**：[开发者个人主页](https://dangzitou.github.io)
- **文档维护**：OpenHarmony社区志愿者

### 特别鸣谢
感谢所有为本项目贡献代码、文档和建议的开发者们！

## 许可证

本项目遵循[Mulan PSL v2许可证](http://license.coscl.org.cn/MulanPSL2)。

## 相关资源

### 官方文档
- [OpenHarmony官方文档](https://gitee.com/openharmony/docs)
- [设备驱动子系统文档](https://gitee.com/openharmony/docs/blob/master/zh-cn/readme/驱动子系统.md)
- [Hi3861开发指南](https://device.harmonyos.com/cn/docs/documentation/guide/device-hi3861-introduction-0000001105041060)

### 项目仓库
- [项目源码仓库](https://gitee.com/hihope_iot/hispark-pegasus-smart-car)
- [OpenHarmony主仓库](https://gitee.com/openharmony)
- [Hi3861样例代码](https://gitee.com/openharmony/device_soc_hisilicon)

### 技术支持
- [OpenHarmony开发者社区](https://gitee.com/openharmony/community)
- [HiHope技术论坛](https://bbs.elecfans.com/group_1429)
- [鸿蒙开发者官网](https://developer.harmonyos.com/)

### 硬件采购
- [Hi3861开发板](https://item.taobao.com/item.htm?id=633296694816)
- [配套传感器套件](https://www.hihope.org/product)
- [机器人底盘套件](https://shop.m5stack.com/)

## 常见问题FAQ

### Q1: 如何切换到其他OpenHarmony版本？
**A1**: 本项目基于OpenHarmony 3.0 LTS开发，如需适配其他版本：
- 检查API兼容性
- 更新BUILD.gn配置文件
- 调整头文件引用路径

### Q2: 可以在其他开发板上运行吗？
**A2**: 理论上支持，需要适配以下内容：
- GPIO引脚定义
- PWM控制器配置
- 定时器资源分配
- 中断优先级设置

### Q3: 如何提高循迹精度？
**A3**: 可以尝试以下优化：
- 增加传感器数量（3-5个传感器阵列）
- 实现PID控制算法
- 优化传感器安装位置和角度
- 使用更高分辨率的编码器

### Q4: 电机速度控制不准确怎么办？
**A4**: 检查以下方面：
- PWM频率设置是否合适
- 电源电压是否稳定
- 负载是否过重
- 考虑添加编码器反馈

## 注意事项

### 使用前准备
1. **硬件检查**：确保所有硬件连接正确牢固
2. **电源要求**：使用7.4V-12V直流电源，确保电流足够（建议≥2A）
3. **环境要求**：在平整地面上测试，避免强光直射传感器

### 循迹轨道要求
1. **轨道材质**：使用黑色电胶带（宽度15-20mm）在白色地面制作
2. **轨道设计**：
   - 直线段长度≥30cm
   - 转弯半径≥15cm
   - 避免急转弯或交叉路径
3. **环境光照**：保持稳定的室内光照，避免阴影影响

### 安全注意事项
1. **电源安全**：使用前检查电池电压，避免过放电
2. **运行空间**：确保周围有足够的活动空间（半径≥1米）
3. **调试安全**：调试时可降低运行速度，避免碰撞损坏
4. **存储要求**：长期不用时请取出电池，避免漏液腐蚀

### 维护保养
1. **定期清洁**：保持传感器表面清洁，避免灰尘影响检测
2. **连接检查**：定期检查杜邦线连接是否松动
3. **软件更新**：及时关注OpenHarmony系统更新
4. **备份代码**：做好代码备份，便于故障恢复