# OpenHarmony智能小车

## 项目简介

本项目是基于OpenHarmony物联网轻量级系统开发的智能机器人小车演示程序，支持多种控制模式，包括循迹、超声波避障、手动控制和UDP远程控制等功能。项目采用Hi3861开发板作为主控芯片，集成了WiFi无线通信、多种传感器和执行器。

[开发者个人博客](https://dangzitou.github.io)

## 功能特性

- **多模式切换**：通过按键或远程控制切换停止、循迹、超声波避障、远程控制四种工作模式
- **UDP远程控制**：通过WiFi网络实现无线控制，支持Web界面操作
- **智能循迹**：基于红外传感器实现黑线循迹，支持实时速度调节和智能避障
- **超声波避障**：利用HC-SR04超声波传感器检测障碍物，自动规避碰撞
- **舵机控制**：SG90舵机实现转向控制，增强避障能力
- **OLED显示**：SSD1306 OLED屏幕实时显示当前工作状态和参数
- **速度控制**：支持通过按键或远程调节小车运行速度，可调范围4000-8000
- **PWM驱动**：采用PWM控制电机转速，运行更平稳稳定
- **融合避障循迹**：循迹模式下自动检测前方障碍物，实现安全循迹
- **网络状态监控**：实时显示WiFi连接状态和IP地址信息
- **IP扫描功能**：Web界面支持自动扫描可用IP地址

## 硬件组成

| 组件 | 型号 | 连接GPIO | 功能描述 |
|------|------|----------|----------|
| 主控芯片 | Hi3861 | - | 系统核心控制器，集成WiFi |
| 电机驱动 | L9110S | GPIO0/1/9/10 | 双轮差速驱动 |
| 超声波传感器 | HC-SR04 | GPIO7/8 | 距离检测(Trig/Echo) |
| 舵机 | SG90 | GPIO2 | 转向控制 |
| 红外传感器 | TCRT5000 | GPIO11/12 | 循迹检测(左/右) |
| OLED显示屏 | SSD1306 | GPIO13/14 | 状态显示(SDA/SCL) |
| 按键/电位器 | - | GPIO5 | 模式切换和速度调节 |
| WiFi模块 | 内置 | - | 无线通信，UDP控制 |

## 目录结构

```
robot_demo/
├── BUILD.gn                # 构建配置文件
├── robot_control.c         # 主控制逻辑
├── robot_control.h         # 控制接口头文件
├── robot_hcsr04.c          # 超声波传感器驱动
├── robot_l9110s.c          # 电机驱动控制
├── robot_sg90.c            # 舵机控制
├── trace_model.c           # 循迹模块
├── ssd1306_test.c          # OLED显示控制
├── udp_control.c           # UDP远程控制模块
├── udp_control.h           # UDP控制接口头文件
├── car_remote_control.py   # Web遥控器服务端
├── ssd1306/                # OLED驱动库
│   ├── BUILD.gn
│   ├── ssd1306.c
│   ├── ssd1306.h
│   ├── ssd1306_conf.h
│   ├── ssd1306_fonts.c
│   └── ssd1306_fonts.h
├── .vscode/                # VSCode配置文件
│   ├── settings.json
│   └── launch.json
└── README.md               # 项目说明文档
```

## 工作模式

### 1. 停止模式（CAR_STOP_STATUS）
- 小车停止运动，所有电机刹车
- OLED显示 "Robot Car Stop" 和当前速度
- 等待用户切换到其他模式
- 仍接收UDP控制指令但不执行运动

### 2. 循迹模式（CAR_TRACE_STATUS）
- 基于红外传感器检测黑线轨道
- 自动调整左右轮速度保持循迹
- **融合避障功能**：每50ms检测前方障碍物
- 检测到障碍物时自动停车，距离安全后恢复循迹
- 支持四种运动状态：
  - 直行：两个传感器都检测到白色
  - 左转：左传感器检测到黑线，右传感器检测到白色
  - 右转：右传感器检测到黑线，左传感器检测到白色
  - 刹车：两个传感器都检测到黑线（终点线检测）
- OLED显示 "trace"、当前速度和行进状态
- 支持实时速度调节（通过按键或UDP）

### 3. 超声波避障模式（CAR_OBSTACLE_AVOIDANCE_STATUS）
- 前方检测到障碍物时自动避障
- 舵机左右转动探测最佳路径
- 距离小于20cm时后退并转向
- OLED显示 "ultrasonic"

### 4. 远程控制模式（CAR_CONTROL_STATUS）
- **新增**：通过UDP接收远程控制指令
- 支持前进、后退、左转、右转、停止等基本动作
- 支持实时速度调节
- 需要在此模式下才能响应运动控制指令
- OLED显示 "control" 和网络状态

## 控制接口

### 按键控制
- **短按USER**：循环切换工作模式（停止→循迹→避障→远程控制→停止）
- **按键调节**：在循迹模式下调节运行速度，按S1或S2加速

### UDP远程控制
**新增功能**：通过WiFi网络实现无线控制

#### 控制指令格式（JSON）
```json
// 模式切换
{"mode": "control"}         // 切换到远程控制模式
{"mode": "trace"}           // 切换到循迹模式
{"mode": "obstacle_avoidance"}  // 切换到避障模式
{"mode": "stop"}            // 切换到停止模式

// 运动控制（需在远程控制模式下）
{"cmd": "forward"}          // 前进
{"cmd": "backward"}         // 后退
{"cmd": "left"}            // 左转
{"cmd": "right"}           // 右转
{"cmd": "stop"}            // 停止

// 速度控制
{"cmd": "speed", "value": 6000}  // 设置速度值（4000-8000）
```

#### 网络配置
- **UDP端口**：50001
- **服务器模式**：小车作为UDP服务器监听
- **IP显示**：启动时OLED显示小车IP地址
- **连接状态**：实时监控网络连接状态

### Web遥控器使用
1. **启动遥控器**：
```bash
python car_remote_control.py
```

2. **访问控制界面**：浏览器打开 `http://127.0.0.1:5000`

3. **IP设置**：在界面中输入小车IP地址并保存

4. **IP扫描**：可自动扫描网段内可用IP地址

5. **控制功能**：
   - 模式切换：通过下拉菜单选择工作模式
   - 速度调节：拖动滑块调整运行速度
   - 方向控制：点击方向按钮控制移动

### 速度参数
- `SPEED_FORWARD`：前进速度（默认：6000，范围：4000-8000）
- `SPEED_TURN`：转弯速度（默认：5000）
- `PWM_DUTY_MAX`：最大PWM占空比（8000）
- `PWM_FREQ`：PWM频率（8000Hz）
- 速度调节步长：100（Web界面）、1000（按键）

### 避障参数
- `DISTANCE_BETWEEN_CAR_AND_OBSTACLE`：避障检测距离（20.0cm）
- 避障检测频率：每50ms检测一次
- 红外传感器采样频率：每1ms采样一次

## 编译和运行

### 环境要求
- OpenHarmony 3.0 LTS 或更高版本
- Hi3861开发板
- DevEco Device Tool
- Python 3.x（用于Web遥控器）
- Flask库（`pip install flask`）

### 编译步骤
1. 确保项目位于OpenHarmony源码树中
2. 配置构建环境：
```bash
hb set
# 选择hispark_pegasus产品
```

3. 编译项目：
```bash
hb build
```

4. 烧录固件到Hi3861开发板

### 运行说明
1. **小车端**：
   - 在`sta_entry.c`中修改连接的WiFi名称与密码后编译
   - 上电后系统自动初始化
   - OLED屏幕显示 "Hello OpenHarmony!"
   - 连接WiFi后显示IP地址
   - 按下按键切换到所需工作模式

2. **遥控器端**：
   - 运行 `python car_remote_control.py`
   - 浏览器访问 `http://127.0.0.1:5000`
   - 设置小车IP地址
   - 开始远程控制

## 技术特点

- **实时性**：采用1ms定时器确保循迹响应速度
- **网络通信**：WiFi UDP协议实现低延迟远程控制
- **安全性**：循迹模式下自动避障，防止碰撞
- **智能检测**：50ms超声波检测周期，平衡性能与功耗
- **状态管理**：严格的模式切换逻辑，防止指令冲突
- **防抖设计**：按键防抖和重复指令过滤
- **精确控制**：PWM驱动电机，速度控制精确平滑
- **跨平台**：Web界面支持多设备控制
- **可扩展性**：模块化设计，便于功能扩展
- **节能设计**：优化检测频率，降低系统功耗

## 故障排除

### 常见问题及解决方案

#### 1. UDP控制连接失败
- **现象**：Web界面无法连接小车
- **原因**：网络配置问题或IP地址错误
- **解决**：
  - 确认小车和电脑在同一网段
  - 检查小车OLED显示的IP地址
  - 使用IP扫描功能查找可用地址
  - 检查防火墙设置

#### 2. 循迹不稳定
- **现象**：小车循迹时摇摆不定或偏离轨道
- **原因**：红外传感器高度不当或轨道反射不均匀
- **解决**：
  - 调整传感器高度至距离地面2-3cm
  - 使用黑色电胶带制作清晰轨道
  - 检查传感器是否被遮挡

#### 3. 避障功能异常
- **现象**：检测到障碍物但不停车，或无障碍物时误停
- **原因**：超声波传感器接线问题或环境干扰
- **解决**：
  - 检查GPIO7(Trig)和GPIO8(Echo)连接
  - 避免在强光或声音干扰环境下使用
  - 确保前方有足够的检测空间

#### 4. 小车不动或速度异常
- **现象**：PWM输出异常或电机不转
- **原因**：电源供电不足或驱动电路故障
- **解决**：
  - 检查电池电压是否充足（≥7.4V）
  - 确认L9110S驱动板连接正确
  - 检查PWM信号输出是否正常

#### 5. WiFi连接问题
- **现象**：小车无法连接WiFi或获取IP失败
- **原因**：WiFi配置错误或信号弱
- **解决**：
  - 检查WiFi热点配置
  - 确保信号强度充足
  - 重启小车重新连接

#### 6. OLED显示异常
- **现象**：屏幕无显示或显示乱码
- **原因**：I2C通信问题或初始化失败
- **解决**：
  - 检查GPIO13(SDA)和GPIO14(SCL)连接
  - 确认OLED模块电源连接
  - 重新上电复位系统

## 性能优化建议

### 硬件优化
1. **电源系统**：使用稳压模块确保供电稳定
2. **传感器安装**：确保红外传感器水平安装，高度一致
3. **机械结构**：减少车体重量，提高机械精度
4. **线路布局**：使用屏蔽线减少电磁干扰
5. **WiFi天线**：确保天线位置远离干扰源

### 软件优化
1. **定时器优化**：可根据实际需求调整检测频率
2. **滤波算法**：对传感器数据进行软件滤波
3. **PID控制**：实现更精确的速度和方向控制
4. **状态机优化**：增加更多的运动状态以适应复杂路况
5. **网络优化**：优化UDP数据包大小和发送频率

### 扩展功能建议
1. **实时视频传输**：添加摄像头模块实现视频监控
2. **语音提示**：添加蜂鸣器或语音模块
3. **数据记录**：记录运行轨迹和性能数据
4. **多车协同**：支持多台小车协同工作
5. **传感器融合**：集成更多传感器提高智能化水平

## 核心算法

### 循迹算法
```c
// 循迹逻辑状态机
if (左传感器 == 黑线 && 右传感器 == 黑线) {
    状态 = 刹车;  // 终点线检测或停止
} else if (右传感器 == 黑线 && 左传感器 == 白色) {
    状态 = 右转;  // 左轮转动，右轮停止
} else if (左传感器 == 黑线 && 右传感器 == 白色) {
    状态 = 左转;  // 右轮转动，左轮停止
} else if (左传感器 == 白色 && 右传感器 == 白色) {
    状态 = 直行;  // 双轮同速前进
}
```

### 避障算法
```c
// 每50ms执行一次避障检测
if (检测计数器 >= 50) {
    距离 = GetDistance();
    if (距离 < 20cm) {
        if (!已检测到障碍物) {
            停止小车();
            设置避障标志();
        }
    } else {
        if (已检测到障碍物) {
            清除避障标志();
            恢复循迹();
        }
    }
}
```

### UDP控制算法
```c
// JSON指令解析和处理
void cotrl_handle(char *recvline, int ret) {
    cJSON *recvjson = cJSON_Parse(recvline);
    
    // 处理模式切换
    cJSON *modeItem = cJSON_GetObjectItem(recvjson, "mode");
    if (modeItem != NULL) {
        if (strcmp("control", modeItem->valuestring) == 0) {
            g_car_status = CAR_CONTROL_STATUS;
            // 同时处理控制指令
            if (cmdItem != NULL) udp_control(recvline);
        }
        // 其他模式处理...
    }
    
    // 处理控制指令
    else if (cmdItem != NULL) {
        udp_control(recvline);
    }
}
```

## 版本历史

### v3.0.0 (2025-07-08)
- **新增UDP远程控制功能**：WiFi无线控制支持
- **新增Web遥控器**：跨平台浏览器控制界面
- **新增IP扫描功能**：自动发现可用IP地址
- **优化模式切换逻辑**：添加远程控制模式
- **增强安全性**：严格的指令权限检查
- **改进状态显示**：OLED显示网络信息

### v2.0.0 (2025-07-08)
- 优化终点线检测宽度（ms）
- Robot Car Stop模式下也能在OLED屏幕显示速度

### v1.5.0 (2025-07-07)
- 优化超声波检测频率（50ms）
- 添加终点线检测
- 转弯时电机一前一后

### v1.0.0 (2025-07-04)
- 基础循迹功能实现
- 超声波避障功能
- PWM电机控制

## 许可证

本项目遵循[Mulan PSL v2许可证](http://license.coscl.org.cn/MulanPSL2)。

## 相关资源

### 官方文档
- [OpenHarmony官方文档](https://gitee.com/openharmony/docs)
- [设备驱动子系统文档](https://gitee.com/openharmony/docs/blob/master/zh-cn/readme/驱动子系统.md)
- [Hi3861开发指南](https://device.harmonyos.com/cn/docs/documentation/guide/device-hi3861-introduction-0000001105041060)

### 项目仓库
- [项目源码仓库](https://gitee.com/hihope_iot/hispark-pegasus-smart-car)
- [OpenHarmony主仓库](https://gitee.com/openharmony)
- [Hi3861样例代码](https://gitee.com/openharmony/device_soc_hisilicon)

### 技术支持
- [OpenHarmony开发者社区](https://gitee.com/openharmony/community)
- [HiHope技术论坛](https://bbs.elecfans.com/group_1429)
- [鸿蒙开发者官网](https://developer.harmonyos.com/)

## 常见问题FAQ

### Q1: 如何配置WiFi连接？
**A1**: 在代码中配置WiFi热点信息：
- 修改WiFi SSID和密码
- 确保热点支持2.4GHz频段
- 重新编译并烧录固件

### Q2: UDP控制延迟太高怎么办？
**A2**: 可以尝试以下优化：
- 检查网络信号强度
- 减少UDP数据包大小
- 优化WiFi路由器配置
- 使用5GHz频段（如支持）

### Q3: 可以同时支持多个遥控器吗？
**A3**: 当前版本支持多客户端连接：
- UDP服务器可接收多个客户端指令
- 但建议单一控制避免指令冲突
- 可扩展为多用户权限管理

### Q4: 如何扩展更多控制指令？
**A4**: 在`udp_control.c`中添加新的指令处理：
- 定义新的JSON指令格式
- 在`udp_control()`函数中添加处理逻辑
- 更新Web界面对应功能

### Q5: 循迹模式下能否响应UDP指令？
**A5**: 当前设计为模式独占：
- 循迹模式下不响应运动控制指令
- 可以响应模式切换和速度调节指令
- 确保安全性和行为一致性

## 注意事项

### 使用前准备
1. **硬件检查**：确保所有硬件连接正确牢固
2. **电源要求**：使用7.4V-12V直流电源，确保电流足够（建议≥2A）
3. **网络环境**：确保WiFi网络稳定，信号强度充足
4. **环境要求**：在平整地面上测试，避免强光直射传感器

### 循迹轨道要求
1. **轨道材质**：使用黑色电胶带（宽度15-20mm）在白色地面制作
2. **轨道设计**：
   - 直线段长度≥30cm
   - 转弯半径≥15cm
   - 避免急转弯或交叉路径
3. **环境光照**：保持稳定的室内光照，避免阴影影响

### 网络安全注意事项
1. **网络隔离**：建议在局域网内使用，避免公网暴露
2. **访问控制**：Web界面未加密，注意使用环境安全
3. **指令验证**：当前版本无身份验证，请在可信环境使用
4. **数据保护**：避免在控制指令中包含敏感信息

### 安全注意事项
1. **电源安全**：使用前检查电池电压，避免过放电
2. **运行空间**：确保周围有足够的活动空间（半径≥1米）
3. **远程控制**：首次使用时降低速度，熟悉控制响应
4. **网络延迟**：注意网络延迟对控制精度的影响
5. **存储要求**：长期不用时请取出电池，避免漏液腐蚀

### 维护保养
1. **定期清洁**：保持传感器表面清洁，避免灰尘影响检测
2. **连接检查**：定期检查杜邦线连接是否松动
3. **软件更新**：及时关注OpenHarmony系统更新
4. **备份代码**：做好代码备份，便于故障恢复
5. **网络监控**：定期检查网络连接状态和性能